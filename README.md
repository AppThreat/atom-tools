# atom-tools
Collection of tools for use with slices generated by [AppThreat/atom](https://github.com/appthreat/atom).

## Install atom

This program does not generate slices; its purpose is to manipulate slices generated by atom. The 
current documentation for atom is housed in the [AppThreat/atom](https://github.com/AppThreat/atom?tab=readme-ov-file) GitHub repository.

Atom can easily be installed from a [native image](https://github.com/AppThreat/atom#atom-native-image) or via npm `npm install -g @appthreat/atom`.

## Atom-tools installation

`pip install atom-tools`

## CLI Usage

Atom-tools uses py-poetry/cleo to construct its command-line interface and therefore uses the same 
sorts of conventions as the Python package management utility poetry.

To access the commands help menu, enter `atom-tools list` for a list of available commands.

Individual command options can be accessed with `atom-tools help ` and the command name (e.g. `atom-tools help 
convert`).
```
Atom Tools (version 0.5.0)

Usage:
  command [options] [arguments]

Options:
  -h, --help            Display help for the given command. When no command is given display help for the list command.
  -q, --quiet           Do not output any message.
  -V, --version         Display this application version.
      --ansi            Force ANSI output.
      --no-ansi         Disable ANSI output.
  -n, --no-interaction  Do not ask any interactive question.
  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug.

Available commands:
  convert         Convert an atom slice to a different format.
  filter          Filter an atom slice based on specified criteria.
  help            Displays help for a command.
  list            Lists commands.
  validate-lines  Check the accuracy of the line numbers in an atom slice.
```

## Features
### Filter
The filter command can be run on its own to produce a filtered slice or used before another command
to filter a slice before executing another command on it. Please note that for line numbers, the 
strategy is to include any slice in its entirety which includes the given line number or line 
number range in one of its fields.

#### Chaining filter commands
The filter command can act on itself by specifying an additional filter command as an argument.
This may desirable for certain use cases where one wishes some criteria to be required.

**Example**

`atom-tools filter -i slices.json --criteria filename=myfile -e "filter --criteria resolvedMethod=mymethod,resolvedMethod=mymethod2 convert"`

This would be equivalent to

`if fileName == 'myfile' and (resolvedMethod == 'mymethod' or resolvedMethod == 'mymethod2'):`


#### Available attributes (not case-sensitive):
- fileName
- fullName
- resolvedMethod
- callName
- name
- signature

| attribute      | locations                                                                                                                                                   |
|----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| name           | objectSlices.usages.targetObj, objectSlices.usages.definedBy, userDefinedTypes.fields                                                                       |
| callName       | objectSlices.usages.targetObj, objectSlices.usages.definedBy, userDefinedTypes.procedures,                                                                  |
| resolvedMethod | objectSlices.usages.targetObj, objectSlices.usages.definedBy, objectSlices.usages.argToCalls, objectSlices.usages.invokedCalls, userDefinedTypes.procedures |
| fullName       | objectSlices                                                                                                                                                |
| signature      | objectSlices                                                                                                                                                |
| fileName       | objectSlices, userDefinedTypes                                                                                                                              |                                                                                                                          |

#### Criteria syntax
Multiple criteria can be given by using a comma as a separator (no space)

`--criteria [attribute]=[value],[attribute2]=[value],...`

Examples:
`--criteria filename=server.ts`
`--criteria filename=server.ts,filename=server.ts`

#### Usage

```
Description:
  Filter an atom slice based on specified criteria.

Usage:
  filter [options] [--] <slice-file> <cmd>

Arguments:
  slice-file               The atom slice file to filter.
  cmd

Options:
  -c, --criteria=CRITERIA  Filter based on an attribute of the slice. Please see documentation for syntax and available attributes.
  -o, --outfile=OUTFILE    File to re-export filtered slice to.
      --strict             Strict mode filters on all attributes (must match all rather than any).
  -h, --help               Display help for the given command. When no command is given display help for the list command.
  -q, --quiet              Do not output any message.
  -V, --version            Display this application version.
      --ansi               Force ANSI output.
      --no-ansi            Disable ANSI output.
  -n, --no-interaction     Do not ask any interactive question.
  -v|vv|vvv, --verbose     Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug.

Help:
  The filter command filters an atom slice based on specified criteria.

```
#### Examples
***Filter with the convert command.***

`atom-tools filter -i usages.slices.json --criteria fileName=server.ts  -e "convert -f openapi3.0.1 -o openapi_usages.json -t java"`

The above will produce an OpenAPI document based only on slices generated from server.ts.

This can be expanded upon by including a line number or range of line numbers with the filename.

`atom-tools filter -i usages.slices.json --criteria fileName=server.ts:220-250 -e "convert -f openapi3.0.1 -o openapi_usages.json -t java"`

The above can be used to identify endpoints located between lines 220-250 in server.ts.

***Filter based on another attribute***

`atom-tools -i usages.slices.json filter --criteria resolvedMethod=validateSignup`

The above will create a filtered json that only includes slices where the resolved method equals "validateSignup". Since no command is specified, the filtered
slice will only be written to file.

>Filtering can also be used to exclude. The first example could be changed to exclude server.ts with the following:
>>`atom-tools filter --criteria fileName!=server.ts usages.slices.json convert -f openapi3.0.1 -o openapi_usages.json -t java `

>Multiple filter criteria may be included. The following example will produce a filtered slice based only on server.ts slices and exclude calls to addUser.
> >`atom-tools filter --criteria fileName=server.ts,callName!=addUser usages.slices.json`

>Note that the input slice should not be specified for commands used with filter as the new filtered slice will be the source. If they are specified, atom-tools will replace.


### Convert 
The convert command can be used to output an atom slice in a different format. The current 
capabilities are limited to processing usages in order to generate endpoints for an openapi 3.x 
paths object. Future iterations will populate the path item objects with more details based on 
atom slices.

```
Description:
  Convert an atom slice to a different format

Usage:
  convert [options]

Options:
  -f, --format=FORMAT              Destination format [default: "openapi3.0.1"]
  -i, --input-slice=INPUT-SLICE  Usages slice file
  -t, --type=TYPE                  Origin type of source on which the atom slice was generated. [default: "java"]
  -o, --output-file=OUTPUT-FILE    Output file [default: "openapi_from_slice.json"]
  -s, --server=SERVER              The server url to be included in the server object.
  -h, --help                       Display help for the given command. When no command is given display help for the list command.
  -q, --quiet                      Do not output any message.
  -V, --version                    Display this application version.
      --ansi                       Force ANSI output.
      --no-ansi                    Disable ANSI output.
  -n, --no-interaction             Do not ask any interactive question.
  -v|vv|vvv, --verbose             Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug.

Help:
  The convert command converts an atom slice to a different format.
      Currently supports outputting an OpenAPI 3.x document based on a usages
      slice.
```

**Example**
>`atom-tools convert -i usages.slices.json -f openapi3.0.1 -o openapi_usages.json -t java -s https://myserver.com`


### Validate Lines
The validate-lines command checks the accuracy of the line numbers reported by
atom against your source files.

```
Description:
  Check the accuracy of the line numbers in an atom slice.

Usage:
  validate-lines [options]

Options:
  -i, --input-slice=INPUT-SLICE  Slice file to validate. [default: "slices.json"]
  -t, --type=TYPE                Origin type of source on which the atom slice was generated. [default: "java"]
  -d, --base-path=BASE-PATH      This should be the same path that was used by atom when the slice was generated.
  -l, --interval=INTERVAL        Try matching within a range. Ex. slice has line number 567, with interval of 5, we check lines 562-572. Use 0 for exact matching. [default: 5]
  -r, --report=REPORT            Output summary to file.  [default: "output.txt"]
  -j, --export-json=EXPORT-JSON  JSON report file to store invalid lines. Include valid lines as well using -v flag.
  -h, --help                     Display help for the given command. When no command is given display help for the list command.
  -q, --quiet                    Do not output any message.
  -V, --version                  Display this application version.
      --ansi                     Force ANSI output.
      --no-ansi                  Disable ANSI output.
  -n, --no-interaction           Do not ask any interactive question.
  -v|vv|vvv, --verbose           Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug.
  
Help:
  Validate source file line numbers in an atom usages or reachables slice.
```

**Example**
>`atom-tools validate-lines -t java -j project_json_report.json -i usages.slices.json -d /home/my_project_dir`
